"use strict";angular.module("digiviewApp",["ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/view/:sequenceNo",{templateUrl:"views/view.html",controller:"ViewCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("digiviewApp").controller("MainCtrl",["$scope","SolrService",function(a,b){a.disableNextButton=!1,a.$on("search-results-updated",function(){a.results=b.results,a.disableNextButton=a.results.items.length===a.results.totalGroups?!0:!1}),a.loadMoreResults=function(){b.nextPage()}}]),angular.module("digiviewApp").constant("Configuration",{production:"http://115.146.84.251",testing:"http://115.146.84.251",loglevel:"DEBUG",deployment:"testing",allowedRouteParams:[],site:"DCVW",keywordSearchOperator:"AND",datasetStart:"2000-01-01T00:00:00Z",datasetEnd:"2014-12-31T23:59:59Z"}),angular.module("digiviewApp").factory("SolrService",["$rootScope","$http","$routeParams","$route","$location","$timeout","$window","Configuration",function a(b,c,d,e,f,g,h,i){function j(){console.debug("############"),console.debug("############ APPLICATION INITIALISED"),console.debug("############"),a.filters={},a.dateFilters={},a.results={},a.facets={},a.searchType="keyword";var b;b=void 0!==d.site?d.site:i.site,a.deployment=i[i.deployment],a.site=b,a.solr=a.deployment+"/"+a.site+"/select",console.debug("Solr Service: "+a.solr),console.debug("Site: "+a.site),E()>0&&sessionStorage.removeItem("cq");var c=a.loadData();void 0!==c&&c.site!==a.site&&sessionStorage.removeItem("cq");var c=a.loadData();return void 0!==c?m():n(),!0}function k(){var a=sessionStorage.getItem("cq");return angular.fromJson(b.$eval(a))}function l(){var a=k();h.location=a.site===i.site?"#/":"#/"+a.site}function m(){var c=a.loadData();a.appInit=!0,console.debug("Initialising app from saved data"),a.q=c.q,a.filters=c.filters,a.dateFilters=c.dateFilters,a.term=c.term,a.searchType=c.searchType,a.sort=c.sort,void 0!==c.nResults&&(a.rows=c.nResults),console.log(a.rows),g(function(){b.$broadcast("app-ready"),a.appInit=!1},300)}function n(){a.appInit=!0,console.debug("Bootstrapping app"),a.term=void 0!==d.q?d.q:"*",angular.forEach(d,function(b,c){if(-1!==i.allowedRouteParams.indexOf(c)&&"q"!==c){if("object"==typeof b)for(var d=0;d<b.length;d++)a.filterQuery(c,b[d],!0);else a.filterQuery(c,b,!0);a.updateFacetCount(c)}}),angular.forEach(d,function(a,b){-1!==i.allowedRouteParams.indexOf(b)&&f.search(b,null)}),g(function(){b.$broadcast("app-ready"),a.appInit=!1},300)}function o(b,c){var d,e,f=a.term;"*"===f||"~"===f.substr(-1,1)?d="(title:"+f+"^20 OR text:"+f+"^10)":"keyword"===a.searchType?(f=f.replace(/ /gi," "+i.keywordSearchOperator+" "),d="title:("+f+")^20 OR text:("+f+")^10"):d='title:"'+f+'"^20 OR text:"'+f+'"^10',void 0!==c&&(d+=" AND group:"+c);var g=x().join(" AND ");return void 0===g&&(g=""),e=void 0===a.sort?"*"===f?"score desc":"score desc":a.sort,a.resultSort=e,d={url:a.solr,params:{q:d,start:b,rows:a.rows,wt:"json","json.wrf":"JSON_CALLBACK",fq:g,group:!0,"group.field":"group","group.sort":"page asc","group.ngroups":!0}},void 0!==c&&(d.params["group.limit"]=-1),a.q=d,a.q}function p(){var b={date:Date.now(),term:a.term,q:o(0),filters:a.filters,dateFilters:a.dateFilters,searchType:a.searchType,sort:a.sort,site:a.site};if(1!==a.results.items.length)b.nResults=a.results.items.length;else{var c=k();b.nResults=c.nResults}sessionStorage.setItem("cq",angular.toJson(b))}function q(d,e,f,g){f&&(a.suggestion=void 0,b.$broadcast("search-suggestion-removed")),(d!==a.term||0===e)&&(a.results.items=[],a.results.start=0),a.term=d;var h=o(e,g);console.debug("query: ",h),c.jsonp(a.solr,h).then(function(a){r(a)})}function r(c){if(console.log(c),void 0===c)a.results={term:a.term,total:0,items:[]};else{var d;d=void 0!==a.results.items?a.results.items:[],angular.forEach(c.data.grouped.group.groups,function(a){d.push(a.doclist)}),a.results={term:a.term,totalGroups:c.data.grouped.group.ngroups,totalMatches:c.data.grouped.group.matches,start:parseInt(c.data.responseHeader.params.start),items:d},angular.forEach(a.results.items,function(b,c){a.results.items[c].sequenceNo=c+1})}u(),p(),b.$broadcast("search-results-updated")}function s(){var b=a.results.items.length;q(a.term,b)}function t(d,e,f){void 0===e&&(e=0),void 0===f&&(f=10);var g=o(0);g.params.facet=!0,g.params["facet.field"]=d,g.params["facet.limit"]=f,g.params["facet.sort"]="count",g.params["facet.offset"]=e,g.params.rows=0,c.jsonp(a.solr,g).then(function(c){angular.forEach(c.data.facet_counts.facet_fields,function(c,d){for(var e=[],f=0;f<c.length;f+=2)e.push([c[f],c[f+1],!1]);a.facets[d]=e,b.$broadcast(d+"-facets-updated")})})}function u(){angular.forEach(a.facets,function(b,c){a.updateFacetCount(c)}),b.$broadcast("update-date-facets")}function v(b,c,d){if(void 0===a.filters[b])a.filters[b]=[c];else if(-1===a.filters[b].indexOf(c))a.filters[b].push(c);else{var e=a.filters[b].indexOf(c);a.filters[b].splice(e,1),0===a.filters[b].length&&delete a.filters[b]}d!==!0&&(a.results.docs=[],a.results.start=0,q(a.term,0,!0))}function w(b,c,d,e){var f,g,h,i;f=e.split(" - ")[0],g=e.split(" - ")[1],i=void 0!==c&&void 0!==d?c+"-"+d+"-"+e.replace(" - ","_"):b+"-"+e.replace(" - ","_"),a.dateFilters[i]?delete a.dateFilters[i]:(h={from:f+"-01-01T00:00:00Z",to:g+"-12-31T23:59:59Z",facetField:b,label:e,existenceFromField:c,existenceToField:d},a.dateFilters[i]=h),a.results.docs=[],a.results.start=0,q(a.term,0,!0)}function x(){var b,c=[];for(b in a.filters){var d=a.filterUnion[b];c.push(b+':("'+a.filters[b].join('" '+d+' "')+'")')}var e=[];for(b in a.dateFilters){var f=a.dateFilters[b];if(void 0!==f.existenceFromField&&void 0!==f.existenceToField){var g,g="(exist_from:["+i.datasetStart+" TO "+f.to+"]";g+=" AND ",g+="exist_to:["+f.from+" TO "+i.datasetEnd+"])",e.push(g)}else{var g=f.facetField+":["+f.from+" TO "+f.to+"]";e.push(g)}}return c.length>0&&e.length>0?c=c.concat(["("+e.join(" OR ")+")"]):e.length>0&&(c=["("+e.join(" OR ")+")"]),c}function y(){a.filters={},a.dateFilters={},q(a.term,0,!0),b.$broadcast("reset-all-filters")}function z(b){delete a.filters[b],q(a.term,0,!0)}function A(){a.hideDetails=!a.hideDetails,b.$broadcast(a.hideDetails===!0?"hide-search-results-details":"show-search-results-details")}function B(){q(a.term,0)}function C(){var b={url:a.solr,params:{q:"*:*",start:0,rows:1,wt:"json","json.wrf":"JSON_CALLBACK",sort:"exist_from asc"}};c.jsonp(a.solr,b).then(function(b){a.dateStartBoundary=b.data.response.docs[0].exist_from;var d={url:a.solr,params:{q:"*:*",start:0,rows:1,wt:"json","json.wrf":"JSON_CALLBACK",sort:"exist_from desc"}};c.jsonp(a.solr,d).then(function(b){a.dateEndBoundary=b.data.response.docs[0].exist_to,a.compileDateFacets()})})}function D(d,e,f,g,h){b.$broadcast("reset-date-facets");var i;i=o(0),i.params.rows=0,i.params.facet=!0,i.params["facet.range"]=d,i.params["facet.range.start"]=f+"-01-01T00:00:00Z",i.params["facet.range.end"]=g+"-12-31T23:59:59Z",i.params["facet.range.gap"]="+"+h+"YEARS",c.jsonp(a.solr,i).then(function(c){var f,i,j=c.data.facet_counts.facet_ranges[d].counts;i=[];var k=(new Date).getFullYear();for(f=0;f<j.length;f+=2){var l=parseInt(j[f].split("-")[0])+parseInt(h)-1;l>g&&(l=g),l>k&&(l=k),i.push({rangeStart:parseInt(j[f].split("-")[0]),rangeEnd:l,count:j[f+1]})}var m=d+"_"+e;a.dateFacets[m]=i,b.$broadcast(m+"-facet-data-ready")})}var E=function(){var a=[];return angular.forEach(f.search(),function(b){a.push(b)}),a.length};b.$on("$routeUpdate",function(){if(!a.appInit)if(d.site!==a.site||E()>0)sessionStorage.removeItem("cq"),j(a.deployment,d.site);else{var b=sessionStorage.getItem("cq");null!==b?m(sessionStorage.getItem("cq")):j(a.deployment,d.site)}});var a={results:{},facets:{},dateFacets:{},filters:{},filterUnion:{},dateFilters:{},searchType:"phrase",term:"*",rows:10,defaultRows:10,sort:void 0,resultSort:void 0,hideDetails:!1,init:j,redirectToRoot:l,loadData:k,search:q,saveData:r,nextPage:s,updateFacetCount:t,filterQuery:v,getFilterObject:x,filterDateQuery:w,clearFilter:z,clearAllFilters:y,toggleDetails:A,reSort:B,dateOuterBounds:C,compileDateFacets:D};return a}]),angular.module("digiviewApp").directive("searchBox",["SolrService",function(a){return{templateUrl:"views/search-box.html",restrict:"E",scope:{help:"@",searchType:"@"},link:function(b){b.$on("app-ready",function(){b.searchBox=a.term,b.setSearchType(a.searchType!==b.searchType?a.searchType:b.searchType),a.rows!==a.defaultRows&&(a.rows=a.defaultRows)}),b.setSearchBox=function(){b.searchBox="*"},b.search=function(){""===b.searchBox&&(b.searchBox="*"),a.search(b.searchBox,0,!0)},b.setSearchType=function(c){a.searchType=c,"phrase"===a.searchType?(b.keywordSearch=!1,b.phraseSearch=!0):(b.phraseSearch=!1,b.keywordSearch=!0),b.search()},b.setSearchBox(),b.ready=a.init()}}}]),angular.module("digiviewApp").directive("itemMatchList",["SolrService",function(a){return{templateUrl:"views/item-match-list.html",restrict:"E",link:function(b){b.$on("search-results-updated",function(){b.items=a.results.items})}}}]),angular.module("digiviewApp").directive("smoothzoom",["$window","$timeout",function(){return{template:"",restrict:"A",link:function(a,b){a.init=function(){b.smoothZoom({animation_SPEED_ZOOM:.5,animation_SPEED_PAN:.5,animation_SMOOTHNESS:5,zoom_MAX:100,background_COLOR:"black",button_ALIGN:"top right",button_AUTO_HIDE:!0,button_SIZE:26,responsive:!0})},a.$watch("image_pane_height",function(){console.log("image pane height changed"),b.smoothZoom("destroy"),a.init()}),b.on("load",function(){a.init()})}}}]),angular.module("digiviewApp").controller("ViewCtrl",["$scope","$routeParams","SolrService",function(){}]),angular.module("digiviewApp").directive("viewSet",["$window","$location","$anchorScroll","$timeout","$routeParams","SolrService",function(a,b,c,d,e,f){return{templateUrl:"views/view-set.html",restrict:"E",scope:{},link:function(d){if(d.smallImages=[],d.largeImageMap={},d.styleMap={},d.largeImageById=[],d.showFilmstrip=!0,d.showInformation=!1,d.$on("search-results-updated",function(){d.data=f.results.items[0].docs,angular.forEach(d.data,function(a,b){d.smallImages.push({id:b,src:a.thumb_image})}),d.current=0,d.loadImage(d.current)}),void 0===f.results.term)a.location="#/";else{var g=f.results.items[e.sequenceNo-1];f.search(f.results.term,0,!0,g.docs[0].group)}var h=angular.element(a);h.bind("resize",function(){d.$apply(function(){i(),d.loadImage(d.current)})});var i=function(){d.height=a.innerHeight,d.width=a.innerWidth,d.navbar_height=50,d.showFilmstrip===!0?(d.image_pane_height=.8*(a.innerHeight-d.navbar_height),d.filmstrip_height=a.innerHeight-d.navbar_height-d.image_pane_height,d.image_height=.9*d.filmstrip_height):d.image_pane_height=a.innerHeight-d.navbar_height};i(),d.loadImage=function(a){d.current!==a&&(d.current=a);var e=d.data[a];d.image=e.large_image,d.show=!1,d.show=!0;var f=b.hash();b.hash(d.current),c(),b.hash(f),0===d.current&&d.data.length>1?(d.showNext=!0,d.showPrevious=!1):d.current===d.data.length-1&&d.data.length>1?(d.showNext=!1,d.showPrevious=!0):(d.showNext=!0,d.showPrevious=!0)},d.next=function(){d.current+=1,d.loadImage(d.current)},d.previous=function(){d.current-=1,d.loadImage(d.current)},d.jumpToStart=function(){d.current=0,d.loadImage(d.current)},d.jumpToEnd=function(){d.current=d.data.length-1,d.loadImage(d.current)},d.toggleFilmstrip=function(){d.showFilmstrip=!d.showFilmstrip,i()},d.toggleInformation=function(){d.showInformation=!d.showInformation}}}}]);